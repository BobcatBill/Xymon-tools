#!/bin/bash
#########
#### Setup Section
########
cd `dirname $0`
CMDPATH="/sbin/"
COLUMN=sm_raid
COLOR="red"
LOGFILE="${BBTMP}/sm_raid.log"
LOCATIONLINE="This message generated by `pwd`/`basename $0` on `hostname --fqdn`"
read -d ' ' DISKLIST <<"EOF"
/dev/sdd
/dev/sdc
/dev/sdb
/dev/sda

EOF

##########
##### Pre-flight Checks
##########
if test "$BBHOME" = ""; then
  echo "BBHOME is not set...exiting"
  exit 1
fi

if sudo /sbin/dmraid -s| grep "no raid disks" ; then
	mdstat	
else
	dmraid
fi
#######################
######## Function
#######################
function dmraid {
sudo $CMD >> $LOGFILE
if grep "status" $LOGFILE |grep inconsistent; then
	DISK=`dmraid -r |sort -rn| diff $DISKLIST - |grep dev |cut -c3-100`
	COLOR="red"
	MSGLINE="disk $DISK has failed"
else 
	COLOR=green
	MSGLINE="All is well"
fi
DETAILS=`cat $LOGFILE`
}

function mdstat {

 if [ `cat /proc/mdstat | grep "(F)"` -eq 0 ] ; then 
	COLOR="red"
else
	COLOR="green"

fi

DETAILS=`cat /proc/mdstat`

}


$BB $BBDISP "status $MACHINE.$COLUMN $COLOR `date`
${MSGLINE}

${DETAILS}

$LOCATIONLINE
"
rm $LOGFILE
exit 0
